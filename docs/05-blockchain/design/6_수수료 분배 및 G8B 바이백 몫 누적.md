## **1. 컨트랙트 개요**

**FeeDistributor**는 SettlementManager에서 **결제가 완료(Paid)**된 정산 건에 대해  
저작자·플랫폼·바이백 몫을 정확한 비율로 계산하고  
Monad L1에서 **USDT0를 실제로 분배하는 컨트랙트**이다.

역할을 요약하면:

- SettlementManager의 상태 기반 Settlement 소비
- Config에서 수수료 정책 조회 (platformFee, buybackFee, authorTier별 보상 증가율 등)
- StrategyRegistry에서 저작자(author) 주소 조회
- USDT0 분배 (transferFrom + allowance 기반)
- BuybackTreasury로 buyback 몫 이동
- 정산 완료에 대한 이력 이벤트 발생  
    → 투명한 회계체계 완성

---

# **2. FeeDistributor의 고유 역할**

|기능|설명|
|---|---|
|Settlement 소비|SettlementManager에서 Paid된 건만 받아 사용|
|수수료 계산|authorShare / platformShare / buybackShare 계산|
|자금 이동|모든 몫을 Monad USDT0로 송금|
|바이백 풀 누적|buybackShare를 BuybackTreasury 주소에 보관|
|모든 Settlement 완료 이력 기록|FeeDistributed 이벤트|

FeeDistributor는 **소각(burn)**을 직접 하지 않는다.  
소각은 BuybackTreasury의 역할이다.

---

# **3. Settlement 소비 구조**

FeeDistributor는 SettlementManager에서 다음 조건을 만족하는 Settlement만 처리한다:

- `status == Paid`
- `amountUSDT > 0`
- SettlementManager에서 이미 결제 검증 완료

SettlementManager가 지급 여부를 온체인에서 관리하므로  
FeeDistributor는 Settlement의 “금액/티어 스냅샷”에만 집중한다.

---

# **4. 퍼센트 구조 (FeeConfig)**

FeeDistributor는 `Config` 컨트랙트를 참조하여 **“정산된 수수료(amountUSDT)”를 내부에서 어떻게 나눌지**에 대한 비율을 가져온다.  
여기서 `amountUSDT`는 이미 **기본 수수료율 0.2%에 유저 Tier 할인(10~50%)이 적용된 후의 최종 수수료 총액**이다.

Config에서 정의되는 전역 비율은 다음과 같다:

- `platformFeeBps`  
  - 최종 수수료(amountUSDT) 중 **플랫폼 몫** 비율 (예: 5000 = 50%)
- `buybackFeeBps`  
  - 최종 수수료 중 **G8D 바이백/소각 몫** 비율 (예: 3000 = 30%)
- `baseAuthorFeeBps`  
  - 최종 수수료 중 **저작자 기본 몫** 비율  
  - GreatDIY에서는 **수수료의 10% = 1000bps**를 기본으로 설정
- `tierAuthorBoostBps[tier]`  
  - 저작자의 **Tier에 따라 추가로 붙는 저작료 증가분**  
  - “저작료 증가” 컬럼과 1:1 매핑  
  - 예시 (Tier 테이블 기준):
    - T0: 0%   → `tierAuthorBoostBps[0] = 0`
    - T1: +5%  → `tierAuthorBoostBps[1] = 500`
    - T2: +10% → `tierAuthorBoostBps[2] = 1000`
    - T3: +25% → `tierAuthorBoostBps[3] = 2500`
    - T4: +50% → `tierAuthorBoostBps[4] = 5000`
    - T5: +100%→ `tierAuthorBoostBps[5] = 10000`

최종 저작자 몫 비율은 다음과 같이 계산된다:

```text
authorShareBps = baseAuthorFeeBps + tierAuthorBoostBps[authorTierSnapshot]
platformShareBps = platformFeeBps
buybackShareBps  = buybackFeeBps
```

---

# **5. Token Flow (자금 흐름)**

FeeDistributor는 Treasury가 미리 제공해 둔 allowance를 사용해  
유저가 Treasury에 납부한 USDT0를 분배한다.

### **전제: Treasury → FeeDistributor allowance 제공**

Treasury는 다음을 수행:

`USDT0.approve(FeeDistributor, uint256 max)`

FeeDistributor는 분배 시 아래처럼 호출한다:

`USDT0.transferFrom(Treasury, author, authorShare) USDT0.transferFrom(Treasury, PlatformTreasury, platformShare) USDT0.transferFrom(Treasury, BuybackTreasury, buybackShare)`

즉,

### **유저 → Treasury 로 결제**

↓

### **FeeDistributor → author / PlatformTreasury / BuybackTreasury 로 분배**

이 흐름으로 모든 자금 이동이 완결된다.

---

# **6. 기능(Functions)**

## **6-1. distribute()**

### **호출 권한**

- 누구나 호출 가능 (public)
- SettlementManager가 Paid인 Settlement만 처리
- Settlement당 1회만 실행됨

### **시그니처 예시**

`function distribute(bytes32 settlementId) external;`

### **동작 흐름**

1. SettlementManager에서 Settlement 조회
2. status == Paid 확인  
    → 아니면 revert (중복 방지)
3. amountUSDT, userTierSnapshot, authorTierSnapshot 로드
4. Config에서 BPS 비율 로드
5. StrategyRegistry에서 author 주소 조회
6. USDT0 세 곳으로 분배:
    - authorShare → author
    - platformShare → PlatformTreasury
    - buybackShare → BuybackTreasury
7. SettlementManager에 “Distributed 완료” 표시 (선택)
8. `FeeDistributed(...)` 이벤트 발생

---

## **6-2. distributeBatch()**

여러 Settlement를 한 번에 처리하기 위한 함수  
(옵션)

`function distributeBatch(bytes32[] calldata settlementIds) external;`

---

## **6-3. setTreasury / setBuybackTreasury (ADMIN)**

운영 환경 교체, 멀티시그 변경 등을 고려해  
Admin이 Treasury 주소를 변경할 수 있도록 한다.

`function setTreasury(address newTreasury) external onlyRole(ADMIN); function setBuybackTreasury(address newBuyback) external onlyRole(ADMIN);`

---

# **7. 필드(저장)**

`IERC20 public usdt0; address public treasury;          // platform treasury address public buybackTreasury;   // 바이백 적립 풀 Config public config; SettlementManager public settlementManager; StrategyRegistry public strategyRegistry;  mapping(bytes32 => bool) public distributed; // 재분배 방지`

---

# **8. 이벤트(Event)**

|이벤트|설명|
|---|---|
|**FeeDistributed(settlementId, author, authorShare, platformShare, buybackShare)**|정산 분배 발생|
|**TreasuryUpdated(old, new)**|Treasury 주소 변경|
|**BuybackTreasuryUpdated(old, new)**|Buyback 주소 변경|

---

# **9. 다른 컨트랙트와의 연동**

## **9-1. SettlementManager**

- SettlementManager에서 Paid된 Settlement만 소비
- Settlement의 Snapshots(userTierSnapshot / authorTierSnapshot)을 기반으로 계산
- Settlement의 amountUSDT 사용

## **9-2. StrategyRegistry**

- author 주소 조회
- strategy가 Active 상태였던 기록 기반

## **9-3. BuybackTreasury**

- buybackShare가 누적되는 목적지
- FeeDistributor는 소각을 하지 않고, **BuybackTreasury가 실제 소각/스왑 실행**

---

# **10. 보안(Security Notes)**

### **1) 중복 분배 방지**

`distributed[settlementId] = true` 처리 필수

### **2) USDT0 allowance 전략**

- Treasury가 FeeDistributor에 무제한 approve
- Admin이 approve revoke 가능
- Treasury는 멀티시그 컨트랙트 권장

### **3) author 주소 검증**

StrategyRegistry를 신뢰하므로  
StrategyRegistry 주소는 immutable 또는 Admin-only 변경 구조 유지

### **4) 계산 신뢰성**

- BPS 합이 10000 이하인지 Config에서 보장
- BPS 변경은 timelock을 통해 투명성 확보 가능

---

# **11. 전체 흐름 요약**

`SettlementManager: SettlementPaid           ↓ FeeDistributor.distribute(settlementId)           ↓ Config에서 BPS 비율 조회           ↓ StrategyRegistry에서 author 조회           ↓ authorShare    → author 지갑 platformShare  → PlatformTreasury buybackShare   → BuybackTreasury           ↓ FeeDistributed 이벤트`

---

# **12. 요약**

**FeeDistributor**는 GreatDIY 경제 모델의 핵심 결제 엔진이며,  
모든 유료 Settlement를 실제 돈 흐름으로 연결하는 컨트랙트다.

- Paid Settlement만 처리
- author / 플랫폼 / 바이백 몫 자동 분배
- buyback 몫은 BuybackTreasury로 적립
- 모든 흐름은 Monad L1의 USDT0 기반
- SettlementManager / StrategyRegistry / Config와 강하게 결합
- G8D Tokenomics의 실행 레이어

FeeDistributor는 **정산 → 분배 → 바이백**의 첫 구간을 담당하며  
GreatDIY 프로토콜의 투명성과 신뢰도를 만드는 핵심 요소다.