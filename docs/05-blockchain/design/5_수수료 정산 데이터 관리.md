## **1. ì»¨íŠ¸ë™íŠ¸ ê°œìš”**

**SettlementManager**ëŠ” GreatDIY ìë™ë§¤ë§¤ ì‹œìŠ¤í…œì—ì„œ  
**ìœ ì €ê°€ ì‚¬ìš©í•œ ì „ëµê³¼ ì‹¤ì œ ì •ì‚°í•´ì•¼ í•  ê¸ˆì•¡**ì„  
í•˜ë£¨ ë‹¨ìœ„ë¡œ ì˜¨ì²´ì¸ì— ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ê¸°ë¡í•˜ëŠ” í•µì‹¬ ì»¨íŠ¸ë™íŠ¸ë‹¤.

í•µì‹¬ ì—­í• :

1. `(user + strategyId + dayIndex)`ì— ëŒ€í•œ **ì •ì‚° ìŠ¤ëƒ…ìƒ· ìƒì„±**
2. ì •ì‚° ìƒíƒœ (`Pending â†’ Paid / Expired`) ì˜¨ì²´ì¸ ê¸°ë¡
3. FollowRegistryì™€ ì—°ë™í•˜ì—¬ ë¯¸ì •ì‚°/ì—°ì²´ ì‹œ ìë™ ì¼ì‹œì •ì§€(Pause)
4. FeeDistributorê°€ â€œPaidëœ ì •ì‚°â€ë§Œì„ ê°€ì ¸ê°€ ë¶„ë°°í•˜ë„ë¡ ì—°ê²°
5. ì •ì‚° ê³¼ì • ì „ì²´ë¥¼ **íˆ¬ëª…Â·ê°ì‚¬ ê°€ëŠ¥í•œ ì˜¨ì²´ì¸ ê¸°ë¡ìœ¼ë¡œ ë‚¨ê¸°ëŠ” ë ˆì´ì–´**

SettlementManagerëŠ” GreatDIYì˜  
**íšŒê³„(Accounting Layer)** ì—­í• ì„ í•˜ëŠ” ì»¨íŠ¸ë™íŠ¸ë‹¤.

---

## **2. Settlement Key êµ¬ì¡°**

ê° SettlementëŠ” ë‹¤ìŒ 3ê°œì˜ ê°’ìœ¼ë¡œ ê³ ìœ í•˜ê²Œ ì‹ë³„ëœë‹¤:

`key = (userAddress, strategyId, dayIndex)`

- `userAddress` : ì‹¤ì œ ì „ëµì„ ì‚¬ìš©í•œ ìœ ì € ì£¼ì†Œ
- `strategyId` : StrategyRegistryì— ë“±ë¡ëœ ì „ëµ ID
- `dayIndex` : UTC+0 ê¸°ì¤€ í•˜ë£¨ ID (DecisionHistory, FollowRegistryì™€ ë™ì¼ ê¸°ì¤€)

í•˜ë£¨ ë‹¨ìœ„ ì •ì‚° ëª¨ë¸ì´ê¸° ë•Œë¬¸ì—  
**í•˜ë£¨ì— í•˜ë‚˜ì˜ settlement**ë§Œ ìƒì„±ë˜ëŠ” ê²ƒì´ ì›ì¹™ì´ë‹¤.

---

## **3. Settlement êµ¬ì¡°ì²´**

`struct Settlement {     uint256 amountUSDT;        // í•´ë‹¹ ì¼ìì˜ ì •ì‚° ê¸ˆì•¡ (USDT0)     uint64  createdAt;         // settlement ìƒì„± ì‹œì (ë¸”ë¡ íƒ€ì„)     uint64  deadline;          // createdAt + settlementWindow     uint8   status;            // Pending / Paid / Expired     uint8   userTierSnapshot;  // Settlement ìƒì„± ì‹œì ì˜ ìœ ì € í‹°ì–´     uint8   authorTierSnapshot;// ì „ëµ ì €ì‘ìì˜ í‹°ì–´(snapshot)     uint64  dayIndex;          // ì´ Settlementê°€ ì†í•œ ë‚      // (ì„ íƒ) volume, pnl ë“± ì˜¤í”„ì²´ì¸ ê²€ì¦ìš© ìˆ«ì ìš”ì•½ê°’ }`

### **status ê°’ ì •ì˜**

|status|ì„¤ëª…|
|---|---|
|**Pending (0)**|ì •ì‚° ìƒì„±ë¨, ì•„ì§ ê²°ì œë˜ì§€ ì•ŠìŒ|
|**Paid (1)**|ìœ ì €ê°€ ì •ì‚°ì•¡ì„ ê²°ì œí–ˆìŒ|
|**Expired (2)**|ìœ ì €ê°€ ê¸°í•œ ë‚´ ê²°ì œí•˜ì§€ ì•Šì•„ ë§Œë£Œë¨|

---

## **4. ìƒíƒœ ë³€ìˆ˜**

`mapping(bytes32 => Settlement) public settlements;`

- key: `keccak256(abi.encode(user, strategyId, dayIndex))`
- Settlement ì¡°íšŒÂ·ìƒíƒœ ê°±ì‹  ëª¨ë‘ ì´ ë§¤í•‘ì„ í†µí•´ ì´ë£¨ì–´ì§

ì¶”ê°€ì ìœ¼ë¡œ:

`uint256 public totalSettlements; Config public config; // settlementWindow ë“± ê¸€ë¡œë²Œ ì„¤ì • FollowRegistry public followRegistry; StrategyRegistry public strategyRegistry;`

---

# **5. Settlement ìƒì„± íë¦„**

## **5-1. Settlement ìƒì„± (createSettlement)**

**í˜¸ì¶œ ê¶Œí•œ: SETTLEMENT_OPERATOR (ì˜¤í”„ì²´ì¸ ì—”ì§„/ë°±ì—”ë“œ)**  
ìœ ì €ë‚˜ ì „ëµ ì €ì‘ìëŠ” ìƒì„±í•  ìˆ˜ ì—†ë‹¤.

`createSettlement(     address user,     uint256 strategyId,     uint64  dayIndex,     uint256 amountUSDT,     uint8   userTierSnapshot,     uint8   authorTierSnapshot )`

### **ì¡°ê±´**

- StrategyRegistry:  
    `strategy.status == Active`
- FollowRegistry:  
    `(user, strategyId)` ìƒíƒœê°€ `Active`ì˜€ë˜ ê¸°ê°„ì´ì–´ì•¼ í•¨
- Settlement ì¤‘ë³µ ìƒì„± ë¶ˆê°€

### **ë™ì‘**

1. key = hash(user, strategyId, dayIndex) ìƒì„±
2. `status = Pending`
3. `createdAt = block.timestamp`
4. `deadline = createdAt + settlementWindow`
5. `amountUSDT`, `userTierSnapshot`, `authorTierSnapshot` ì €ì¥
6. ì´ë²¤íŠ¸ ë°œìƒ  
    `SettlementCreated(...)`

## ğŸ“Œ **(ì¤‘ìš”) Settlement ê¸ˆì•¡(amountUSDT) ê³„ì‚° ê·œì¹™**

Settlement ìƒì„± ì‹œ ë°±ì—”ë“œëŠ” ì•„ë˜ ê³µì‹ì„ ì‚¬ìš©í•´ ë‹¹ì¼ ì •ì‚° ê¸ˆì•¡ì„ ê³„ì‚°í•œë‹¤.  
ì´ ê°’ì€ SettlementManagerì— ì €ì¥ë˜ë©°, FeeDistributorì—ì„œ ë¶„ë°°ì˜ ê¸°ì¤€ì´ ëœë‹¤.

### **1) ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨**

`baseFeeRate = 0.2% = 0.002`

---

### **2) ì‚¬ìš©ì ìˆ˜ìˆ˜ë£Œ í• ì¸ (Tier ê¸°ë°˜)**

`effectiveFeeRate = baseFeeRate Ã— (1 - userDiscountRateSnapshot)`

#### ì˜ˆì‹œ

- T0 = 0% â†’ 0.2%
    
- T2 = 20% â†’ 0.16%
    
- T5 = 50% â†’ 0.10%
    

---

### **3) ì €ì‘ì ì €ì‘ë£Œ ë¹„ìœ¨ (Tier ê¸°ë°˜)**

`baseAuthorRate = 10%  = 0.10  effectiveAuthorRate = baseAuthorRate Ã— (1 + authorIncreaseRateSnapshot)`

#### ì˜ˆì‹œ

- T0 = +0% â†’ 10%
    
- T2 = +10% â†’ 11%
    
- T5 = +100% â†’ 20%
    

---

### **4) ê²°ì œ ê¸ˆì•¡(amountUSDT) ê³„ì‚° ê³µì‹**

`amountUSDT = tradingVolume Ã— effectiveFeeRate`

ì—¬ê¸°ì„œ `tradingVolume`ì€ ë‹¹ì¼ í•´ë‹¹ ì „ëµìœ¼ë¡œ ë°œìƒí•œ ì´ ì²´ê²° ê¸ˆì•¡.

Settlementì—ëŠ” ë‹¤ìŒ ê°’ë“¤ì´ ì €ì¥ëœë‹¤:

- amountUSDT
    
- userTierSnapshot
    
- authorTierSnapshot
    
- (FeeDistributorëŠ” ê²°ì œëœ amountë¥¼ ê¸°ë°˜ìœ¼ë¡œ authorShare ê³„ì‚°)

---

## **5-2. Settlement ê²°ì œ(Paid) ì²˜ë¦¬: markPaid**

**í˜¸ì¶œ ê¶Œí•œ: SETTLEMENT_OPERATOR**

ìœ ì €ëŠ” ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.  
ìœ ì €ëŠ” USDT0ë¥¼ Treasury ì£¼ì†Œë¡œ ë³´ë‚´ëŠ” ê²°ì œë§Œ ìˆ˜í–‰í•œë‹¤.

ë°±ì—”ë“œê°€ ë¸”ë¡ì²´ì¸ì—ì„œ ê²°ì œë¥¼ ê°ì§€í•˜ë©´:

`markPaid(bytes32 settlementId)`

### **ì¡°ê±´**

- settlement.status == Pending
- í˜„ì¬ block.timestamp â‰¤ deadline  
    (ê¸°í•œ ë‚´ ê²°ì œì—¬ì•¼ Paid ì¸ì •)

### **ë™ì‘**

1. `status = Paid`
2. ì´ë²¤íŠ¸ `SettlementPaid(...)`
3. FeeDistributorê°€ ì´ Settlementë¥¼ consumeí•  ìˆ˜ ìˆë„ë¡ ìƒíƒœ í™•ì •

---

## **5-3. ì •ì‚° ë§Œë£Œ ì²˜ë¦¬ (Expired): markExpired**

**ëˆ„êµ¬ë‚˜ í˜¸ì¶œ ê°€ëŠ¥ (public)**  
â†’ íˆ¬ëª…ì„± í™•ë³´, ìë™í™”ëœ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œë„ í˜¸ì¶œ ê°€ëŠ¥

`markExpired(bytes32 settlementId)`

### **ì¡°ê±´**

- settlement.status == Pending
- í˜„ì¬ block.timestamp > deadline

### **ë™ì‘**

1. `status = Expired`
2. `SettlementExpired(...)` ì´ë²¤íŠ¸
3. FollowRegistryì— ê°•ì œ Pause ì‹œê·¸ë„:  
    `followRegistry.pauseDueToExpiredSettlement(user, strategyId, dayIndex)`

ì´ë¡œì¨ â€œë¯¸ì •ì‚° ìƒíƒœì—ì„œëŠ” ìë™ë§¤ë§¤ê°€ ê³„ì† ëŒ ìˆ˜ ì—†ë‹¤â€ëŠ” ê·œì¹™ì„ ê°•ì œí•œë‹¤.

---

# **6. Settlement ì¡°íšŒ ê¸°ëŠ¥**

`getSettlement(user, strategyId, dayIndex)`

- Settlement êµ¬ì¡°ì²´ ë°˜í™˜
- í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ/ê²€ì¦ì UIì—ì„œ í™œìš©

---

# **7. FeeDistributor ì—°ë™**

SettlementManagerëŠ” Settlement stateë§Œ ê´€ë¦¬í•˜ë©°,  
**í† í° ì „ì†¡(ê²°ì œ/ë¶„ë°°)ì€ FeeDistributor ë‹´ë‹¹**ì´ë‹¤.

FeeDistributorëŠ” SettlementManagerì—ì„œ ë‹¤ìŒ ë‘ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” Settlementë§Œ ê°€ì ¸ê°„ë‹¤:

- status == Paid
- amountUSDT > 0

ê·¸ë¦¬ê³  ë‚˜ì„œ:

- ì €ì‘ì share
- platform share
- buyback share  
ì„ ì²˜ë¦¬í•˜ê²Œ ëœë‹¤.

SettlementManagerëŠ” **ê¸ˆì „ ì´ë™ì„ ì ˆëŒ€ ìˆ˜í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.**  
íšŒê³„ ìŠ¤ëƒ…ìƒ·ê³¼ ìƒíƒœë§Œ ë‹´ë‹¹í•œë‹¤.

---

# **8. StrategyRegistry & FollowRegistry ì—°ë™**

## **8-1. FollowRegistry**

Settlement ìƒì„± ì‹œ:

- Follow ìƒíƒœê°€ Activeì˜€ë˜ ë‚ ì—ë§Œ Settlement ê¸°ë¡
- Settlement Expired â†’ FollowRegistry ìë™ Pause

## **8-2. StrategyRegistry**

Settlement ìƒì„± ì‹œ:

- ì „ëµì´ Activeì´ì–´ì•¼ ì •ì‚° ê°€ëŠ¥
- ì „ëµì´ Suspendedë©´ Settlement ìƒì„± ë¶ˆê°€

---

# **9. DecisionHistory ì—°ë™**

ì •ì‚° ìƒì„± ì‹œ:

- ë°˜ë“œì‹œ `DecisionHistory.commit[dayIndex]`ê°€ ì¡´ì¬í•´ì•¼ í•œë‹¤  
    â†’ â€œí•´ë‹¹ ë‚  ìë™ë§¤ë§¤ê°€ ì¡´ì¬í–ˆë‹¤ëŠ” ì¦ëª…(anchor)â€
- raw logsëŠ” ì˜¤í”„ì²´ì¸ì— ìˆê³ , rootHashë§Œ on-chain
- Settlement ìƒì„± ì „ commit ìœ ë¬´ ì²´í¬ ê°€ëŠ¥

---

# **10. ì´ë²¤íŠ¸(Event)**

|ì´ë²¤íŠ¸|ì„¤ëª…|
|---|---|
|`SettlementCreated(user, strategyId, dayIndex, amount, createdAt, deadline)`|ìƒˆë¡œìš´ Settlement ìƒì„±|
|`SettlementPaid(user, strategyId, dayIndex, amount)`|ì •ì‚° ê²°ì œ í™•ì¸|
|`SettlementExpired(user, strategyId, dayIndex)`|ê¸°í•œ ì´ˆê³¼ë¡œ ì •ì‚° ë§Œë£Œ|
|`SettlementOverridden(...)` (ì„ íƒ)|ADMINì´ ìˆ˜ë™ ìˆ˜ì • ì‹œ|

ì´ë²¤íŠ¸ëŠ” ì˜¤í”„ì²´ì¸ PostgreSQL/ì¸ë±ì„œì—ì„œ  
ì •ì‚° íˆìŠ¤í† ë¦¬ë¥¼ ì™„ì „í•˜ê²Œ ì¬êµ¬ì„±í•˜ëŠ” ë° í™œìš©ëœë‹¤.

---

# **11. ë³´ì•ˆ( Security Considerations )**

### **1) ê¶Œí•œ ë¶„ë¦¬**

- ì •ì‚° ìƒì„±/ê²°ì œ í™•ì •: SETTLEMENT_OPERATOR
- ë§Œë£Œ ì²˜ë¦¬: ëˆ„êµ¬ë‚˜
- ê°•ì œ ìˆ˜ì •: ADMIN

### **2) ê¸ˆì „ ì´ë™ ì—†ìŒ**

SettlementManagerëŠ” USDT0ë¥¼ ì§ì ‘ ë‹¤ë£¨ì§€ ì•ŠëŠ”ë‹¤.  
ëª¨ë“  ê¸ˆì „ ì´ë™ì€

- ìœ ì € â†’ Treasury
- FeeDistributor â†’ Author/Treasury/Buyback  
    êµ¬ì¡°ì—ì„œ ì²˜ë¦¬ë˜ë©°  
    SettlementManagerëŠ” ì˜¤ì§ â€œìƒíƒœ ì¦ëª…â€ë§Œ ìˆ˜í–‰í•œë‹¤.

### **3) Timestamp ì˜ì¡´ì„±**

- createdAt / deadlineì€ block.timestamp ê¸°ë°˜
- Miner ì¡°ì‘ ìœ„í—˜ì´ ì—†ì„ ì •ë„ë¡œ ì˜í–¥ ë¯¸ë¯¸í•¨

### **4) Double Payment ë°©ì§€**

- Already Paid settlementì€ ë‹¤ì‹œ markPaid ë¶ˆê°€

### **5) ìŠ¤ëƒ…ìƒ·**

- userTierSnapshot / authorTierSnapshotì€ Settlement ìƒì„± ì‹œì ì— ê³ ì •  
    â†’ ê²°ì œ ì§ì „ ìŠ¤í…Œì´í‚¹ ë“±ê¸‰ ì¡°ì‘ ë°©ì§€

---

# **12. ì „ì²´ íë¦„ ìš”ì•½**

`ìë™ë§¤ë§¤ ì¢…ë£Œ â†’ DecisionHistory.commitRoot(dayIndex)           â†“ FollowRegistry (Active íŒ”ë¡œìš° í™•ì¸)           â†“ SettlementManager.createSettlement(user, strategyId, dayIndex, amount)           â†“ (status = Pending) User â†’ Treasuryë¡œ USDT0 ê²°ì œ           â†“ ë°±ì—”ë“œê°€ ê²°ì œ í™•ì¸ â†’ SettlementManager.markPaid           â†“ FeeDistributorê°€ Paidëœ Settlementë§Œ ê°€ì ¸ì™€ ë¶„ë°°           â†“ ê¸°í•œ ì´ˆê³¼ SettlementëŠ” markExpired â†’ FollowRegistry ìë™ Pause`

---

# **13. ìš”ì•½**

SettlementManagerëŠ”  
**â€œëˆ„ê°€ ì–¼ë§ˆë¥¼ ë‚´ì•¼ í•˜ëŠ”ì§€â€ë¥¼ ì˜¨ì²´ì¸ì— ëª…í™•í•˜ê²Œ ê¸°ë¡í•˜ëŠ” íšŒê³„ ì‹œìŠ¤í…œ**ì´ë‹¤.

- ì •ì‚° ìŠ¤ëƒ…ìƒ· ìƒì„±
- ê²°ì œ ì—¬ë¶€ ê¸°ë¡
- ê¸°í•œ ì´ˆê³¼ ì²˜ë¦¬
- íŒ”ë¡œìš° ì¤‘ë‹¨ê³¼ ì—°ë™
- FeeDistributorì—ì„œ ë¶„ë°°ì— ì‚¬ìš©
- DecisionHistoryë¥¼ ê·¼ê±°ë¡œ ì •ì‚° ì‹ ë¢° í™•ë³´

GreatDIYì˜ **íˆ¬ëª…í•œ ìë™ë§¤ë§¤ ìƒíƒœê³„**ë¥¼ êµ¬ì„±í•˜ëŠ” í•µì‹¬ ëª¨ë“ˆì´ë‹¤.