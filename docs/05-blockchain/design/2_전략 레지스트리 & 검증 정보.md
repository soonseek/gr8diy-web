## 1. 컨트랙트 개요

**StrategyRegistry**는 GreatDIY 생태계의 모든 전략(매매 알고리즘)을 온체인에서 **식별·상태관리·검증정보 저장**하는 레이어다.

전략 내용 자체는 LLM이 생성하며 **오프체인(IPFS 등)에 저장되고, 온체인에는 다음 검증·저작권·점수화·상태관리 목적 데이터만 저장**된다.

이 컨트랙트는 다음을 보장한다.

1. **전략의 고유성(identity) 관리**
2. Marketplace 등록에 필요한 **상태관리(State Machine)**
3. 저작자(author) 보상 지급을 위한 **저작권 관리**
4. 검증 파이프라인(LLM + 백테스트 + 리스크 체크)의 결과를 표준화해 **온체인에 기록**

---

## 2. 역할(Role) 연동

StrategyRegistry는 AccessControl/Config의 역할(Role)을 사용한다:

|역할|기능|
|---|---|
|**ADMIN**|상태 강제 변경, 전략 비상 중지|
|**VERIFIER**|검증 결과 기록, 검증 상태 업데이트|
|**BACKEND_RELAYER**|전략 메타데이터 URI 업데이트 등 오프체인 관련 write|
|**TREASURY**|사용 X|
|**SETTLEMENT_OPERATOR**|사용 X|

→ 혼란 없도록 **전략의 검증·상태 변경·마켓 운영 관련 write 작업**은 ADMIN / VERIFIER / BACKEND_RELAYER로 제한하고, 전략 생성·검증 요청·마켓플레이스 등록 요청은 author 본인이 직접 호출하도록 한다.

---

## 3. 전략 데이터 구조

### 3-1. Strategy 상태값

전략은 다음 상태를 가진다:

- `Draft` : 생성되었으나 검증 전
- `PendingReview` : 검증자가 평가 중
- `Verified` : 검증은 통과했으나, 아직 마켓플레이스 공개 요청 전
- `ActivationRequested` : author가 마켓플레이스 공개를 요청한 상태
- `Active` : Marketplace에 공개되어 팔로우 가능
- `Suspended` : 비정상 동작 또는 규정 위반·운영상 이유로 비활성화
- `Rejected` : Activation 요청이 거절된 상태 (선택적으로 사용)

FollowRegistry, SettlementManager는 **`status == Active`인 전략만 팔로우/정산 대상으로 인정**한다.

---

### 3-2. 온체인에 저장되는 Strategy 구조체

`struct Strategy {     address author;     string  metadataURI;          // 전략 코드/설명/LLM 생성물(IPFS)     bytes32 verificationHash;     // 검증 결과(머클루트/해시)     uint16  verificationScore;    // 간단한 스코어(risk/Sharpe/DD)     uint8   status;               // Draft / PendingReview / Verified / ActivationRequested / Active / Suspended / Rejected     uint64  createdAt;            // 생성 시각     uint64  updatedAt;            // 마지막 변경 시각 }`
- status 필드는 3-1에서 정의한 상태값 중 하나를 갖는다.
### 상태 변수

`mapping(uint256 => Strategy) public strategies; mapping(uint256 => bool) public isListed;  uint256 public nextStrategyId;`

- 전략 ID는 오토 인크리먼트
- 저작자·URI·검증 결과 등 모든 전략 정보는 ID 기준 접근
-  `isListed[strategyId]`는 해당 전략이 Marketplace에 노출되는지 여부를 나타낸다. (Active + isListed == true일 때만 일반 유저에게 노출)


---

## 4. 핵심 기능(Function) 명세

권한 범위를 명확하게 적어 논리 충돌을 방지했다.

---

### **4-1. 전략 생성 (Draft 생성)**

**호출 권한: 아무나** (유저 직접 생성 가능)

`createStrategy(string metadataURI) returns (uint256 strategyId)`

- author = msg.sender
- verificationHash = 0
- verificationScore = 0
- status = Draft
- createdAt, updatedAt 기록
- nextStrategyId++

---

### **4-2. 메타데이터 업데이트**

**호출 권한: BACKEND_RELAYER 또는 ADMIN**

`updateMetadataURI(uint256 strategyId, string newURI)`

- 오프체인 파일(IPFS) 업데이트 시 호출
- status 변화 없음
- updatedAt 갱신

백엔드 역할 부여 이유:  
LLM이 전략 수정 후 IPFS에 업데이트한 뒤, 이를 온체인에 반영하기 위해.

---

### **4-3. 검증 요청 → PendingReview 전환**

**호출 권한: author 본인**

`submitForVerification(uint256 strategyId)`

- Draft → PendingReview
- author만 요청 가능 (권리 보호)
- 이미 PendingReview / Verified / ActivationRequested / Active / Suspended / Rejected 상태일 경우 재제출 방지
- 호출 시 `VerificationSubmitted(strategyId)` 이벤트 발생

---

### **4-4. 검증 결과 업로드**

**호출 권한: VERIFIER**

`recordVerification( uint256 strategyId, bytes32 verificationHash, uint16  verificationScore )`

- verificationHash = 백테스트 결과 압축 해시
- verificationScore = 위험도 기반 점수
- status: `PendingReview → Verified`
- updatedAt 갱신
- VERIFIER 검증 결과만 Marketplace 등록 플로우의 전제 조건으로 사용된다.

---

### **4-5. 전략 비활성화 (코어 사용 중지)

**호출 권한: ADMIN**

`deactivateStrategy(uint256 strategyId)`

- status: Active / Verified / ActivationRequested 등 → Suspended
- SettlementManager에서 해당 전략 기반 Settlement 생성 불가
- FollowRegistry는 해당 전략 팔로우를 자동 Pause 처리하거나 신규 팔로우 차단

---

### **4-6. 전략 재활성화** (코어 사용 재허용)

**호출 권한: ADMIN**

`reactivateStrategyCore(uint256 strategyId)`

- status: `Suspended → Verified`
- 이후 author가 필요 시 `requestActivation`을 통해 다시 Marketplace 등록 요청을 할 수 있다.
- 코어 레벨에서 한 번 중지된 전략은, 재검증·재승인 과정을 거친 뒤에만 다시 Active로 전환되도록 강제한다.

### **4-7. 마켓플레이스 등록 요청 (Activation Request 생성)**

**호출 권한: author 본인**

`requestActivation(uint256 strategyId)`

#### 기능

- 검증 완료(Verified) 이후, 전략을 Marketplace에 공개하고 싶을 때 author가 제출하는 “등록 요청”

#### 상태 변화

- `Verified → ActivationRequested`

#### 조건

- `status == Verified`
- author(저작자) 본인만 요청 가능
- 한 번 ActivationRequested가 된 이후에는 다시 요청 불가

#### 의미

- 이 시점에서 전략은 “공개 대기 상태”이며 Marketplace 운영 측에서 추가적인 백테스트 비용 청구·오프체인 검증을 수행할 수 있음

> **중요 포인트 — 요청 = 바로 Active 아님**  
> 비용 결제 / 리스크 확인 / 운영 승인 뒤에 최종 Active로 전환

---

### **4-8. 마켓플레이스 등록 승인 (최종 Active 전환)**

**호출 권한: ADMIN**

`approveActivation(uint256 strategyId)`

#### 기능

- ActivationRequested 상태의 전략을 Marketplace에 실제로 게시

#### 상태 변화:
- `ActivationRequested → Active`
- `isListed[strategyId] = true` (최초 승인 시 기본적으로 마켓에 노출)

#### 조건

- **ADMIN 확인 → 비용 결제 여부 확인 → Active 전환**
- Active 전환 시:
    - FollowRegistry가 이 전략을 “팔로우 가능한 전략”으로 인식  
        → 이후 유저들이 Follow/Unfollow 가능

> 이 구조로 인해, 검증(PendingReview)과 공개(ActivationRequested → Active)가 깔끔히 분리됨

---

### **4-9. 마켓플레이스 등록 거절 (등록 실패)**

**호출 권한: ADMIN**

`rejectActivation(uint256 strategyId)`

#### 기능

- ActivationRequested 상태에서 비용 미납 / 리스크 문제 / 정책 불일치 등 사유로 반려

#### 상태 변화:
- `ActivationRequested → Rejected` (또는 Suspended를 선택적으로 사용 가능)
- 비용 미납, 리스크 초과, 정책 불일치 등의 사유로 반려
#### 이후 흐름 정책:
  - Rejected 상태 전략은 다시 Draft로 되돌리지 않고, author가 전략 내용을 수정한 뒤 **새 전략으로 등록하는 흐름** (혹은 ADMIN이 별도 로직으로 재검증 절차를 허용할 수도 있음)

---

### **4-10. 마켓플레이스 노출 중지 (Unlist)

**호출 권한: ADMIN**

`unlistFromMarketplace(uint256 strategyId)`

- 전략 status는 Active 그대로 유지
- 별도 플래그 `isListed[strategyId] = false`
- 마켓플레이스 UI에서 카드가 숨겨지고, 신규 팔로우 진입 경로가 닫힌다.
- 이미 팔로우 중인 유저는 전략을 계속 사용할 수 있도록 둘지, 함께 Pause할지는 정책으로 결정

---

### **4-11. 전략 재활성화**

**호출 권한: ADMIN**

`relistOnMarketplace(uint256 strategyId)`

- `isListed[strategyId] = true`
- status가 Active인 전략만 재노출 허용
- Marketplace 탭에서 다시 검색·선택 가능

---

## 5. 이벤트(Event) 명세

| 이벤트                                                             | 설명                                            |
| --------------------------------------------------------------- | --------------------------------------------- |
| `StrategyCreated(id, author, metadataURI)`                      | Draft 전략 생성                                   |
| `MetadataUpdated(id, metadataURI)`                              | 메타데이터 변경                                      |
| `VerificationSubmitted(id)`                                     | 검증 요청 시작                                      |
| `VerificationRecorded(id, verificationHash, verificationScore)` | 검증 완료<br>                                     |
| `ActivationRequested(id)`                                       | author가 마켓플레이스 등록을 요청                         |
| `ActivationApproved(id)`                                        | ADMIN이 등록 승인, Active 전환                       |
| `ActivationRejected(id)`                                        | ADMIN이 등록 거절, Rejected(또는 Suspended) 전환       |
| `StrategySuspended(id)`                                         | `deactivateStrategy` 호출 시 발생 (코어 수준 비활성화)     |
| `StrategyReactivated(id)`                                       | `reactivateStrategyCore` 호출 시 발생 (코어 수준 재활성화) |
| `StrategyUnlisted(id)`                                          | `unlistFromMarketplace` 호출 시 발생 (마켓 노출 중단)    |
| `StrategyRelisted(id)`                                          | `relistOnMarketplace` 호출 시 발생 (마켓 재노출)        |
이 모든 이벤트는 오프체인 UI·백엔드에서 상태 추적 용도로 사용된다.

---

## 6. 컨트랙트 간 연동

### SettlementManager

- Settlement 생성 시 전략 상태가 Active인지 확인
- 전략이 Suspended면 그 날의 Settlement 생성 불가

### FollowRegistry

- 전략이 Active 상태일 때만 팔로우 가능
- 신규 팔로우 진입은 `status == Active` 이면서 `isListed == true`인 전략에 대해서만 허용
- 전략이 Suspended면 팔로우 자동 Pause 처리 가능

### FeeDistributor

- 저작자 수익 분배 시 StrategyRegistry에서 `author` 조회
- strategyId → author → 수익 지급

### DecisionHistory

- 전략별 결정 로그 그룹핑 시 strategyId 사용
- 외부에서 strategyId를 기준으로 로그 Merkle Root 생성

---

## 7. 보안 고려사항

- Strategy 검증(verification)은 VERIFIER만 가능
- 검증 결과 업로드 시 metadataURI와 hash 조작 방지 위해 백엔드-LLM 파이프라인에서 서명된 해시 or 스냅샷 추천
- MetadataURI는 **전략 로직이 변경된 경우에만 업데이트**해야 한다
- ADMIN은 필요한 경우 전략을 즉시 정지시킬 수 있음
- reentrancy 우려 없음 (단순 저장)

---

## 8. Constructor & 초기 세팅

constructor는 AccessControl / Config 컨트랙트 주소를 인자로 받는다.

- `nextStrategyId = 1`로 초기화
- 별도 전역 파라미터 없음
- 생성 시 전달받은 Config 주소를 통해 역할(Role) 조회에 사용한다:

`constructor(address configAddress) {  
    config = IConfig(configAddress);  
}`

---

## 9. 요약

- StrategyRegistry는 GreatDIY 전략의 **신원·상태·검증 정보**를 온체인에 보관한다.
- 전략 내용은 오프체인(IPFS), 온체인에는 **저작권·검증 결과·메타데이터**만 기록한다.
- VERIFIER, ADMIN, BACKEND_RELAYER 역할을 명확히 분리해 Marketplace 전략 품질·저작권 보호·검증 과정의 신뢰성을 확보한다.
- FollowRegistry, SettlementManager, FeeDistributor와 자연스럽게 연결된다.

# 전체 흐름(최종 확정판)

아래는 **전략의 라이프사이클을 명확하고 모순 없이 보여주는 트리**다.

```
Draft  
 └─(author → submitForVerification) 
PendingReview  
 └─(VERIFIER → recordVerification) 
Verified  
 └─(author → requestActivation) 
ActivationRequested 
 ├─(ADMIN → approveActivation) → Active  ← Follow 가능 상태 
 └─(ADMIN → rejectActivation) → Rejected (또는 Suspended) 
Active  
 ├─(ADMIN → deactivateStrategy) → Suspended         (코어 중지) 
 └─(ADMIN → unlistFromMarketplace) → Active + isListed=false  (노출만 중지)  
Suspended  
 └─(ADMIN → reactivateStrategyCore) → Verified
```