GreatDIY에서 발생하는 주요 로직들은 스마트컨트랙트를 통해 블록체인에 그 결과가 저장된다. 트랜잭션 속도가 빠른 Monad에 배포한다. G8D 토큰 또한 Monad를 기반으로 발행한다.
## 프로토콜 흐름
### **Chain & Asset Model**
- **스마트컨트랙트 실행 체인**: **MONAD L1**
    - 모든 GreatDIY 프로토콜 로직(정산, 팔로우, 전략 등록, 수수료 계산)이 Monad에서 동작한다.
---
### **정산 자산**: **Monad L1 ERC20 USDT0**
- 사용자는 thirdweb **bridge transaction 위젯**을 통해 Ethereum 등 외부 체인의 USDT → Monad USDT0** 로 자동 브리지 후 결제한다.
- 결제된 USDT0는 프로젝트의 **Monad Treasury 주소**로 모인다.
- Treasury 컨트랙트는 FeeDistributor에 USDT0 `approve` 권한을 부여하고, FeeDistributor는 이 풀에서 저작자/플랫폼/바이백 몫을 `transferFrom`으로 분배한다.
- SettlementManager는 결제 여부만 확인하고 Paid/Expired 상태를 변경한다.
---
### **G8D 토큰 발행 체인**: **Monad L1 ERC20**
- G8D는 Monad 네트워크에서 발행되는 ERC20 토큰이다.
- 스테이킹·저작자 인센티브·Marketplace 우선순위 등 모든 토큰 기반 기능이 Monad 상에서 실행된다.
---
### **Monad 컨트랙트 역할**
- 전략/팔로우/정산 데이터 구조, 요약값, 회계 스냅샷 등을 **모두 Monad 온체인에 영구 기록**
- USDT0 및 G8D 토큰의 **모든 실제 이동도 Monad에서 실행**
- FeeDistributor는 Settlement가 Paid된 후
    - 저작자 USDT0 지급
    - 플랫폼 Treasury 송금
    - 바이백 몫 분리를 Monad에서 바로 수행한다.
---
### **G8D 바이백/소각 구조**
- SettlementManager → FeeDistributor에서 USDT0 수수료 중 **buybackShareUSDT0** 값을 계산해 **Monad Buyback Treasury** 주소로 누적한다.
- **BuybackTreasury 컨트랙트**가 다음을 실행한다:
    1. 누적된 USDT0로 **USDT0 → G8D 스왑** (DEX Router 사용)
    2. 구매된 **G8D를 burn() 또는 dead address로 전송**하여 소각
- 이 모든 과정은 **Monad 네트워크 내부에서 완결**된다.
---
## 스마트컨트랙트
### AccessControl / Config (권한 및 글로벌 파라미터 관리)
[[1_권한 및 글로벌 파라미터 관리]]
- GreatDIY 전체 시스템의 **권한·전역 설정 허브**
- 관리 항목:
    - 정산 기한 (기본: 정산 생성 후 3일)
    - 최소 정산 금액
    - 플랫폼 수수료 비율
    - 저작자 기본 수익 비율 + 스테이킹 등급별 추가 비율
    - G8D 바이백 비율
    - 스테이킹 등급별: 사용자는 G8D 스테이킹 양에 따라 T0~T5 Tier를 받으며,  최대 50%의 수수료 할인과 100%의 저작료 증가, 최대 100개의 Follow Quota를 제공한다.
- 정의되는 주요 역할(Role):
    - **ADMIN**
    - **SETTLEMENT_OPERATOR** (정산 생성)
    - **VERIFIER** (전략 검증)
    - **BACKEND_RELAYER** (Decision commit, Summary commit)
    - **TREASURY**

---
### StrategyRegistry (전략 레지스트리 & 검증 정보)
[[2_전략 레지스트리 & 검증 정보]]
- LLM이 생성한 전략 로직·코드는 **오프체인 저장**
- 온체인에 저장되는 항목:
    - **저작자 주소**
    - **전략 ID**
    - **상태** (Draft / PendingReview / Active / Suspended)
    - **메타데이터 URI** (IPFS 등)
    - **검증 결과 해시 (verificationHash)**
    - **검증 스코어 (risk/샤프·DD 등 간단한 요약값)**
- 목적:
    - 전략이 Marketplace에 등록 가능한 상태인지 판단
    - 저작자의 권리(저작료 지급) 확보

---
### FollowRegistry (구독, 팔로우 관리)
[[3_구독, 팔로우 관리]]
- “**누가 어떤 전략을 사용 중인지**”를 온체인에서 증명
- Follow 레코드 구조:
    - `status` (Active / Paused / Stopped)
    - `sinceDay` (UTC+0 기준 dayIndex)
    - `lastSettledDay` (가장 최근 정산 완료된 dayIndex)
- 역할:
    - SettlementManager가 **정산 생성 대상 사용자**를 판별할 수 있도록 기준 제공
    - Settlement가 Expired되면:
        - FollowRegistry의 `(user, strategyId)` 상태를 자동 **Paused**로 전환  
            → 자동매매 중단 시그널로 사용

---
### DecisionHistory (결정 기록, Commit Log)
[[4_결정 기록, Commit Log]]
- 모든 개별 주문/결정을 온체인에 “풀 데이터”로 기록하면 비효율이므로 **해시/커밋(Merkle Root) 기반 요약 저장소**로 정의
- 기능:
    - `(dayIndex)` 단위 또는 `(dayIndex, batchIndex)` 단위로 **그날의 결정/주문 raw log 전체를 해시 또는 Merkle Root로 커밋**
    - Settlement 생성 시 “오프체인 raw log와 온체인 커밋이 일치함”을 확인하는 감사 기반 제공
- 저장 필드:
    - `dayIndex`
    - `rootHash` (해당 일자 전체 Order Log의 Merkle Root)
    - `batchInfo` (선택)

---
### SettlementManager (수수료 정산 데이터 관리)
[[5_수수료 정산 데이터 관리]]
- 정산 단위(key):
    - `userAddress + strategyId + dayIndex`
- Settlement 구조:
    - `amountUSDT`
    - `createdAt`
    - `deadline = createdAt + 3 days`
    - `status (Pending / Paid / Expired)`
    - **userTierSnapshot**
    - **authorTierSnapshot**
    - (필요 시) volume, pnl 요약값
- 역할:
	- `(user, strategyId, dayIndex)` 단위의 **정산 데이터 스냅샷** 관리
	- 정산액이 **결제되었는지** 여부를 온체인 상태로 기록
- 동작:
	- 백엔드가 모나드의 `SettlementManager`에 (user, strategyId, dayIndex, amountUSDT, userTierSnapshot, authorTierSnapshot)` 형태로 **Settlement 레코드 생성**
	    - `status = Pending`
	- 사용자는 **thirdweb bridge transaction 위젯**을 사용해 **MONAD USDT**로 정산액을 결제
	    - 결제 대상: 프로젝트 MONAD Treasury 주소
	- 백엔드는 MONAD에서 해당 결제 트랜잭션을 확인한 뒤,  `SETTLEMENT_OPERATOR` 권한으로 모나드 `SettlementManager.markPaid(settlementId)` 호출
	    - `status: Pending → Paid`
	- Settlement가 생성된 후 정해진 기한(예: 3일) 이내에 결제가 확인되지 않으면,  
	    누구나 `markExpired(settlementId)` 호출 가능
	    - `status: Pending → Expired`
	    - `FollowRegistry`에 연동하여 해당 `(user, strategyId)` 팔로우를 `Paused` 처리

---
### FeeDistributor (수수료 분배 및 G8D 바이백 몫 누적)
[[6_수수료 분배 및 G8D 바이백 몫 누적]]
- Settlement가 Paid되면 실행
- 분배 항목:
    1. **저작자 몫 (authorShare)**
        - StrategyRegistry에서 저작자 조회
        - Settlement에 기록된 **authorTierSnapshot**을 기준으로 비율 결정
        - Monad USDT0로 즉시 지급
    2. **플랫폼 몫 (treasuryShare)**
        - Monad Treasury 주소로 송금
    3. **G8D 바이백 몫 (buybackShare)**
        - Monad Treasury로 이동
        - FeeDistributor는 buyback pool 누적까지만 책임
        - 이후 BuybackTreasury 컨트랙트에서 실제 소각 처리

---
### BuybackTreasury (바이백 실행 및 소각)
[[7_바이백 실행 및 소각, LP 공급]]
- FeeDistributor에서 전달된 USDT0를 수령
- Uniswap 등 DEX를 이용해 해당 USDT0로 USDT0 → G8D 스왑
- G8D burn

---
### G8DToken (토큰 발행)
[[8_토큰 발행]]
- ERC20
- 초기 분배·락업·팀 물량은 별도 토큰 이코노믹스 문서에서 정의
- FeeDistributor에서 누적된 바이백 몫은  
    BuybackTreasury → DEX → G8D 소각으로 이어짐

---
### G8DStaking (토큰 스테이킹 및 언스테이킹)
[[9_토큰 스테이킹 및 언스테이킹]]
- **Monad G8D를 그대로 스테이킹**한다
- 사용 목적:
    - **화면 노출 가중치**
    - **팔로우 쿼타 증가**
    - **수수료 할인**
    - **저작자의 저작료 비율 상승 (기본 10% → 최대 30% 등)**
- Settlement에서 비율 계산 시:
    - Settlement 생성 시점에 **userTierSnapshot / authorTierSnapshot**을 Settlement에 저장  
        → 결제 시점에 스테이킹 등급을 바꿔 “꼼수 등급 상승”할 수 없게 함
- 스테이킹 정책:
    - **언스테이킹 쿨다운** 또는 **락업 기간** 적용 가능  
        (등급 유지 안정성 확보)

---

## 전체 흐름 요약

1. 전략 생성 → StrategyRegistry에 등록
2. 사용자가 전략 팔로우 → FollowRegistry에 상태 기록
3. 하루 매매 끝 → DecisionHistory에 Merkle Root 커밋
4. SettlementManager가 `(user, strategyId, dayIndex)` 정산 생성
5. 사용자가 Monad USDT0로 결제
6. FeeDistributor가 author / treasury / buyback 몫 분배
    - 바이백 몫은 Monad Treasury로 누적