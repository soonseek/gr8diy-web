## 1. 컨트랙트 개요

**AccessControl / Config**는 GreatDIY 프로토콜 전반에 걸쳐 사용되는  
전역 설정(Global Parameters)과 권한(Role)을 관리하는 핵심 인프라 컨트랙트다.

이 컨트랙트는 다음 기능들을 수행한다:

1. 프로토콜 전체의 **권한 계층 구조(Role-Based Access Control) 관리**
2. 정산·수수료·배분·스테이킹·바이백/소각/Auto-LP 등 모든 모듈에서 사용하는 **전역 파라미터 저장 / 변경 / 조회**
3. 프로토콜 운영 과정에서 발생하는 중요한 정책 변경을 **온체인 이벤트로 영구 기록**하여 투명성을 확보

본 컨트랙트는 다른 모든 컨트랙트  
(StrategyRegistry, FollowRegistry, SettlementManager, FeeDistributor, G8DStaking, BuybackTreasury 등)에 의해 참조되며,  
GreatDIY 프로토콜 전체의 **중앙 설정 레이어** 역할을 한다.

---

## 2. 역할(Role) 정의

GreatDIY는 기본적으로 다음 5개의 권한 역할을 사용한다.

### **① ADMIN**

- 프로토콜 최고 관리자
- 모든 설정 변경 가능
- Role 부여/해제 가능
- 비상 상황 시 Pause 기능 수행 가능
- 업그레이드(Proxy 사용 시) 및 주요 정책 변경 주체

### **② SETTLEMENT_OPERATOR**

- SettlementManager에서 **Settlement 생성/만료 처리** 권한
- 백엔드나 오라클 시스템이 보유하는 역할

### **③ VERIFIER**

- 전략 검증 파이프라인 담당
- StrategyRegistry에 **검증 결과(해시/스코어)** 기록 가능

### **④ BACKEND_RELAYER**

- DecisionHistory의 commit (Merkle Root 기록)
- Day Summary 데이터 업로드(Role 기반)
- 온체인에 “쓰기(write)”가 필요한 자동화 로직 담당

### **⑤ TREASURY**

- 플랫폼 금고 지갑 역할
- FeeDistributor 또는 BuybackTreasury에서 특정 조건 하에 Treasury 주소 필요
- 일반적으로 다중서명(Multisig) 지갑

> 필요하다면 Buyback 실행용 **OPERATOR**(예: BUYBACK_OPERATOR)를 별도 Role로 분리할 수 있지만,  
> 이 문서에서는 Role 정의를 위 5개로 한정하고, Buyback/Auto-LP 실행 주체 Role은 BuybackTreasury 문서에서 구체화한다.

각 역할은 **AccessControl 기반**으로 관리된다.

---

## 3. 전역 설정(Global Parameters)

전역 설정은 여러 카테고리로 나뉜다.

---

### **3-1. Settlement Parameters (정산 파라미터)**

|항목|설명|
|---|---|
|`settlementWindow`|Settlement 생성 후 결제 가능 시간(초 단위) – 기본 3일|
|`minSettlementAmount`|Settlement 레코드가 생성될 최소 수수료 금액|
|`dayIndexDefinition`|dayIndex가 어떤 기준 타임존/규칙으로 산출되는지에 대한 모드 값|

---

### **3-2. Fee & Buyback/LP Parameters (수수료 및 바이백/LP 파라미터)**

|항목|설명|
|---|---|
|`platformFeeBps`|플랫폼 기본 수수료 비율 (basis points)|
|`authorBaseShareBps`|저작자 기본 수익 쉐어 비율|
|`authorMaxShareBps`|스테이킹 등급 적용 시 저작자 최대 비율|
|`buybackShareBps`|수수료 중 G8D **바이백/소각/Auto-LP에 사용될 몫(USDT0)** 비율|
|`buybackBurnRateBps`|BuybackTreasury로 적립된 **USDT0/Buyback 결과 중 “소각용” 비율**|
|`buybackLpRateBps`|BuybackTreasury로 적립된 **USDT0/Buyback 결과 중 “Auto-LP용” 비율**|
|`discountMode`|수수료 할인 적용 방식 enum (None/Linear/TierBased 등)|

- `buybackShareBps`는 **FeeDistributor 레벨**에서 “수수료 → BuybackTreasury로 보내는 USDT0” 비율을 의미한다.
- `buybackBurnRateBps` / `buybackLpRateBps`는 **BuybackTreasury 레벨**에서  
    “적립된 Buyback 재원을 얼마나 소각에 쓰고, 얼마나 DEX 유동성(Auto-LP)에 쓸지”를 결정한다.

제약 조건(권장):

- `platformFeeBps + 기타 수수료 항목`이 10,000bps(= 100%)를 넘지 않도록 체크
- `buybackBurnRateBps + buybackLpRateBps ≤ 10,000` (100%)
    - 일부는 Reserve/Treasury로 남겨두는 구조도 가능

---

### **3-3. Staking Tier Parameters (스테이킹 등급 구조)**

스테이킹 등급은 배열 기반 Tier 구조로 관리된다.

`Tier 0: 기본 등급(스테이킹 없음)`  
`Tier 1: 최소 스테이킹 X`  
`Tier 2: 최소 스테이킹 Y`  
`Tier 3: 최소 스테이킹 Z`  
...

각 Tier마다 다음 항목을 가진다:

|필드|설명|
|---|---|
|`minStake`|해당 등급이 되기 위한 최소 G8D 스테이킹|
|`feeDiscountBps`|유저의 수수료 할인율|
|`authorExtraShareBps`|저작자에게 추가 지급되는 비율|
|`followQuotaBoost`|유저가 구독할 수 있는 전략 수 증가량|

---

### **3-4. System Parameters**

|항목|설명|
|---|---|
|`paused`|전체 프로토콜 정지 여부|
|`version`|Config 컨트랙트 버전 번호|

---

## 4. 데이터 구조 명세

`struct FeeConfig {     uint16 platformFeeBps;     uint16 authorBaseShareBps;     uint16 authorMaxShareBps;     uint16 buybackShareBps;       // 수수료 중 BuybackTreasury로 전달될 몫     uint16 buybackBurnRateBps;    // BuybackTreasury 내부에서 Burn에 사용할 비율     uint16 buybackLpRateBps;      // BuybackTreasury 내부에서 Auto-LP에 사용할 비율     uint8  discountMode;          // enum-like }  struct SettlementConfig {     uint256 settlementWindow;     uint256 minSettlementAmount;     uint8   dayIndexMode; // 0: UTC+0, 1: UTC+9, 등 필요시 확장 }  struct StakingTier {     uint256 minStake;     uint16 feeDiscountBps;     uint16 authorExtraShareBps;     uint8  followQuotaBoost; }`

상태 변수:

`FeeConfig        public feeConfig; SettlementConfig public settlementConfig; StakingTier[]    public tiers;  bool    public paused; uint256 public version;`

> 이로써, **burnRateBps / lpRateBps와 같은 Buyback/LP 정책 비율도  
> 전역 설정 레이어에서 일관되게 관리**된다.

---

## 5. 함수(Function) 명세

### **5-1. Role 관리**

|함수명|설명|
|---|---|
|`grantRole(bytes32 role, address account)`|ADMIN만 호출 가능|
|`revokeRole(bytes32 role, address account)`|ADMIN만 가능|
|`hasRole(bytes32 role, address account)`|조회용|

---

### **5-2. Global Config 업데이트**

아래 모든 설정 변경 함수는 **ADMIN 역할만 호출할 수 있다.**  
(필요하다면 TREASURY 일부 권한 위임 가능)

#### Settlement 관련

- `setSettlementWindow(uint256 window)`
- `setMinSettlementAmount(uint256 amount)`
- `setDayIndexMode(uint8 mode)`

#### Fee / Buyback / LP 관련

- `setFeeConfig(FeeConfig calldata newCfg)`
- 세부 변경 기능 (선택적으로 제공):

`function setPlatformFee(uint16 bps) external onlyAdmin; function setAuthorBaseShare(uint16 bps) external onlyAdmin; function setAuthorMaxShare(uint16 bps) external onlyAdmin; function setBuybackShare(uint16 bps) external onlyAdmin; function setDiscountMode(uint8 mode) external onlyAdmin;`

#### Buyback / Auto-LP 비율 전용 Setter

`function setBuybackRates(     uint16 burnRateBps,     uint16 lpRateBps ) external onlyAdmin;`

- 내부에서 다음과 같은 검증 수행 권장:

`require(burnRateBps + lpRateBps <= 10_000, "Invalid buyback rates");`

- 이 함수가 바로 문서 상에서 말한  
    **“정책 비율(예시: burnRateBps : lpRateBps = 50 : 50,  
    또는 USDT0 기준 70%/30% 등)을  
    거버넌스/멀티시그가 변경하는 진입점”**이 된다.

#### Staking Tier 관련

- `addStakingTier(StakingTier calldata tier)`
- `updateStakingTier(uint256 index, StakingTier calldata tier)`
- `removeStakingTier(uint256 index)`

#### Pause 기능

- `pause() external onlyAdmin`
- `unpause() external onlyAdmin`

---

## 6. 이벤트(Event) 명세

모든 설정 변경은 이벤트로 기록된다.

|이벤트|설명|
|---|---|
|`FeeConfigUpdated(...)`|수수료 및 Buyback/LP 파라미터 변경|
|`SettlementConfigUpdated(SettlementConfig cfg)`|정산 파라미터 변경|
|`StakingTierAdded(uint256 index)`|등급 추가|
|`StakingTierUpdated(uint256 index)`|등급 업데이트|
|`StakingTierRemoved(uint256 index)`|등급 삭제|
|`SystemPaused()`|전체 시스템 Pause|
|`SystemUnpaused()`|전체 시스템 Unpause|
|`BuybackRatesUpdated(uint16 burnRateBps, uint16 lpRateBps)`|Buyback/Burn vs Auto-LP 비율 변경|

예시:

`event FeeConfigUpdated(     uint16 platformFeeBps,     uint16 authorBaseShareBps,     uint16 authorMaxShareBps,     uint16 buybackShareBps,     uint16 buybackBurnRateBps,     uint16 buybackLpRateBps,     uint8  discountMode );  event BuybackRatesUpdated(     uint16 oldBurnRateBps,     uint16 oldLpRateBps,     uint16 newBurnRateBps,     uint16 newLpRateBps );`

이벤트는 백엔드/프론트엔드 동기화에 사용되며  
온체인 정책 변경의 투명성을 위한 중요한 감사(audit) 기록이다.

---

## 7. 다른 컨트랙트들이 참조하는 방식

### StrategyRegistry

- `authorBaseShareBps`, `authorMaxShareBps`
- `VERIFIER` Role 체크

### FollowRegistry

- `followQuotaBoost` (Tier 기반)
- `paused` 여부에 따라 팔로우/언팔로우 제한

### SettlementManager

- `settlementWindow`, `minSettlementAmount`, `dayIndexMode`
- `SETTLEMENT_OPERATOR` Role 체크

### FeeDistributor

- `feeConfig` 전체 참조
    - `platformFeeBps`, `authorBaseShareBps`, `authorMaxShareBps`
    - `buybackShareBps`를 활용해 **수수료 중 일부를 BuybackTreasury로 전달**
- `tiers` 배열을 가져와 배분 비율 계산

### G8DStaking

- Tier 관련 설정 및 `feeDiscountBps`, `authorExtraShareBps` 참조

### BuybackTreasury

- `buybackShareBps` : FeeDistributor 단계에서 어떤 비율로 USDT0가 들어오는지 간접적으로 연관
- `buybackBurnRateBps`, `buybackLpRateBps` :  
    **Buyback 결과물(G8D/USDT0)을 Burn vs Auto-LP로 나눌 때 필수 참조 값**
- 거버넌스에 의해 `setBuybackRates`가 호출되면,  
    BuybackTreasury는 다음 Buyback 시부터 새로운 정책 비율에 따라 동작

---

## 8. 보안 고려사항(Security Model)

- 모든 Role 변경은 ADMIN만 가능
- FeeConfig / BuybackRates / Tier 변경은 고위험 작업 → 반드시 이벤트 기록
- `paused` 상태에서는 Settlement/Distribution/Follow/Buyback 등 핵심 기능 차단
- UUPS/Transparent Proxy 구조 사용 시:
    - ADMIN은 Upgrade 권한도 보유
    - `version` 변수는 업그레이드 시 업데이트

추가로:

- `setBuybackRates` 호출 시 비율 합 검증 필수
- 잘못된 Buyback/LP 비율 설정은 토크노믹스 붕괴로 이어질 수 있으므로  
    멀티시그 + 타임락 조합을 권장

---

## 9. 추가 제안되는 세부 정책

- 설정값 변경에 **Time-lock(48~72시간)** 적용 시,  
    커뮤니티/유저가 변경 사항을 미리 인지 가능 → 신뢰성 상승
- FeeConfig 비율 총합 (플랫폼, 저작자, Buyback 등)은 항상 100% 이내인지 체크
- Tier는 index 순서대로 “상위 등급”이라는 규칙을 문서화 및 UI에 반영
- `paused` 상태에서 호출 불가한 함수 목록을 명확하게 정의  
    (Settlement 생성/결제/분배, Buyback 실행 등)

---

## 10. Constructor & 초기값 정책

### 10.1 목적

AccessControl / Config 컨트랙트의 constructor는 다음을 보장한다.

- 초기 ADMIN 권한 배정
- 프로토콜 핵심 파라미터의 초기값 설정
- 스테이킹 등급(Tier) 구조 초기화
- Buyback/Burn 및 Auto-LP 비율 초기값 확정
- 배포 직후 다른 컨트랙트들이 즉시 참조할 수 있는 기본 정책 제공

---

### 10.2 Constructor 입력값

constructor는 다음 입력값을 받는다.

- `address initialAdmin`
- `FeeConfig initialFeeConfig`
- `SettlementConfig initialSettlementConfig`
- `StakingTier[] initialTiers`

컨트랙트는 이 값들을 그대로 상태 변수에 저장한다.

---

### 10.3 초기 FeeConfig 설정값

- `platformFeeBps`
- `authorBaseShareBps`
- `authorMaxShareBps`
- `buybackShareBps`
- `buybackBurnRateBps`
- `buybackLpRateBps`
- `discountMode`

각 값은 constructor에서 전달받아 설정된다.

> 예:
> 
> - `buybackShareBps = 2000` (수수료의 20%를 BuybackTreasury로)
>    
> - `buybackBurnRateBps = 5000` (그 중 50%는 Burn)
>    
> - `buybackLpRateBps = 5000` (그 중 50%는 Auto-LP)
>    

---

### 10.4 초기 SettlementConfig 설정값

- `settlementWindow`
- `minSettlementAmount`
- `dayIndexMode`

각 값은 constructor에서 전달받아 설정된다.

---

### 10.5 초기 StakingTier 구조

constructor는 `initialTiers` 배열을 순회하며 모든 티어를 내부 `tiers` 배열에 등록한다.

각 Tier는 다음 필드를 가진다.

- `minStake`
- `feeDiscountBps`
- `authorExtraShareBps`
- `followQuotaBoost`

Tier 0이 “스테이킹 없음”에 해당하도록 초기값을 구성하는 것을 권장한다.

---

### 10.6 Constructor 내부 동작

1. `initialAdmin`에게 ADMIN Role 부여
2. `feeConfig = initialFeeConfig`
3. `settlementConfig = initialSettlementConfig`
4. `tiers` 배열 초기화 (`initialTiers` 전체 push)
5. `paused = false`
6. `version = 1` 설정

---

### 10.7 초기값 변경 정책

운영 중 정책 변경은 ADMIN 역할만 수행할 수 있도록 제한한다.  
변경 가능한 항목:

- Settlement 파라미터
- FeeConfig (수수료/Buyback/LP 비율 포함)
- Tier 구조
- pause / unpause

모든 변경은 이벤트로 기록해 버전 관리 및 감사 추적성을 확보한다.

---

### 10.8 요약

- constructor는 GreatDIY 프로토콜의 첫 정책을 온체인에 고정하는 역할을 가진다.
- 배포 직후부터 모든 컨트랙트는 이 초기값을 참조해 정상 동작한다.
- Buyback/Burn/Auto-LP 비율 역시 전역 설정으로 관리되며,  
    이후 정책 변경은 오직 ADMIN(= 멀티시그/거버넌스)만 수행할 수 있다.